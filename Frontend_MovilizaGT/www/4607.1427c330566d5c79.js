"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4607],{4607:(I,p,u)=>{u.r(p),u.d(p,{CreateRoutePageModule:()=>P});var d=u(177),l=u(4341),n=u(4742),h=u(8986),f=u(467),t=u(3953),v=u(7692),k=u(3656),y=u(4132);const C=["waypointInput"];function D(r,w){if(1&r){const e=t.RV6();t.j41(0,"ion-content")(1,"ion-datetime",15),t.bIt("ionChange",function(o){t.eBV(e);const s=t.XpG();return t.Njj(s.onDateSelected(o))})("ionCancel",function(){t.eBV(e);const o=t.XpG();return t.Njj(o.closeDatePicker())}),t.k0s()()}if(2&r){const e=t.XpG();t.R7$(),t.Y8G("value",e.selectedDate)}}const T=[{path:"",component:(()=>{class r{constructor(e,i,o){this.fb=e,this.generalService=i,this.navCtrl=o,this.userId=null,this.markers=[],this.waypoints=[],this.correlativeCounter=1,this.selectedDate=null,this.isDatePickerOpen=!1,this.notificationMessage="",this.notificationType="info",this.isNotificationVisible=!1,this.routeForm=this.fb.group({startTime:["",l.k0.required],startDate:["",l.k0.required],availableSeats:["",[l.k0.required,l.k0.min(1)]],waypoint:[""]}),this.directionsService=new google.maps.DirectionsService,this.directionsRenderer=new google.maps.DirectionsRenderer}ngAfterViewInit(){this.initMap(),this.initAutocomplete(),this.directionsRenderer.setMap(this.map)}ngOnInit(){const e=sessionStorage.getItem("userData");if(e){const i=JSON.parse(e);this.userId=i.userId,console.log("User ID:",this.userId)}}showNotification(e,i){this.notificationMessage=e,this.notificationType=i,this.isNotificationVisible=!0,setTimeout(()=>{this.isNotificationVisible=!1},3e3)}openDatePicker(){this.isDatePickerOpen=!0}closeDatePicker(){this.isDatePickerOpen=!1}onDateSelected(e){this.selectedDate=e.detail.value,this.routeForm.patchValue({startDate:this.selectedDate}),this.closeDatePicker()}initMap(){this.map=new google.maps.Map(document.getElementById("map"),{center:{lat:14.634915,lng:-90.506882},zoom:12})}initAutocomplete(){var e=this;return(0,f.A)(function*(){const i=yield e.waypointInput.getInputElement();e.setupAutocomplete(i)})()}setupAutocomplete(e){const i=new google.maps.places.Autocomplete(e,{componentRestrictions:{country:"GT"}});i.addListener("place_changed",()=>{const o=i.getPlace();if(!o.geometry||!o.geometry.location)return;this.map.setCenter(o.geometry.location),this.map.setZoom(15);const s=new google.maps.Marker({position:o.geometry.location,map:this.map,title:"Punto Intermedio"});this.markers.push({marker:s,location:o.geometry.location,correlative:this.correlativeCounter++}),this.routeForm.patchValue({waypoint:""}),e.value="",this.traceRoute()})}traceRoute(){if(this.markers.length<2)return void this.showNotification("Por favor ingrese al menos dos puntos para trazar una ruta.","warning");const s={origin:this.markers[0].location,destination:this.markers[this.markers.length-1].location,waypoints:this.markers.slice(1,-1).map(a=>({location:a.location,stopover:!0})),travelMode:google.maps.TravelMode.DRIVING};this.directionsService.route(s,(a,c)=>{c===google.maps.DirectionsStatus.OK?(this.directionsRenderer.setDirections(a),this.calculateArrivalTimes(a.routes[0].legs)):console.error("Error al trazar la ruta:",c)})}calculateArrivalTimes(e){const i=this.routeForm.get("startTime")?.value,o=this.routeForm.get("startDate")?.value;if(!i||!o)return void alert("Por favor, ingrese una hora y fecha de inicio");const s=new Date(o).toISOString().split("T")[0];let a=new Date(`${s}T${i}`);this.markers[0].departureTime=this.formatTime(a),e.forEach((g,m)=>{if(m>0){const F=g.duration.value;a=new Date(a.getTime()+1e3*F),this.markers[m].departureTime=this.formatTime(a)}console.log(`Hora de llegada al punto ${m+1}: ${this.markers[m].departureTime}`)});const c=e[e.length-1].duration.value;a=new Date(a.getTime()+1e3*c),this.markers[this.markers.length-1].departureTime=this.formatTime(a),console.log(`Hora de llegada al \xfaltimo punto: ${this.markers[this.markers.length-1].departureTime}`)}formatTime(e){return e.toTimeString().split(" ")[0]}clearMap(){this.markers.forEach(e=>e.marker.setMap(null)),this.markers=[],this.directionsRenderer.set("directions",null)}onCreateRoute(){if(this.routeForm.valid&&this.markers.length>=2){const e=this.routeForm.get("startTime")?.value,i=this.routeForm.get("startDate")?.value,o=e?e+":00":"",s=new Date(i).toISOString().split("T")[0];console.log(this.markers),console.log("USER ID",this.userId);const a={departureTime:o,departureDate:s,availableSeats:this.routeForm.get("availableSeats")?.value,FK_userId:this.userId,stands:this.markers.map((c,g)=>({latitude:c.location.lat(),longitude:c.location.lng(),correlative:c.correlative,departureTime:c.departureTime}))};this.generalService.post("api/createRoute",a).subscribe({next:c=>{this.showNotification("Ruta creada con exito","success"),console.log("Ruta creada exitosamente",c),this.clearMap(),this.navCtrl.navigateRoot("/inicio",{queryParams:{notificationMessage:"Ruta Creada con \xc9xito",notificationType:"success"}})},error:c=>{this.showNotification("Error al crear la ruta","error"),console.error("Error al crear la ruta",c)}})}else console.log("Formulario inv\xe1lido o faltan paradas"),this.showNotification("Por favor, complete el formulario correctamente y agregue al menos dos paradas.","success")}testNotification(){console.log("Testing notification..."),this.showNotification("\xa1Esta es una notificaci\xf3n de prueba!","success")}static#t=this.\u0275fac=function(i){return new(i||r)(t.rXU(l.ok),t.rXU(v.O),t.rXU(k.q9))};static#e=this.\u0275cmp=t.VBU({type:r,selectors:[["app-create-route"]],viewQuery:function(i,o){if(1&i&&t.GBs(C,5),2&i){let s;t.mGM(s=t.lsd())&&(o.waypointInput=s.first)}},decls:37,vars:9,consts:[["waypointInput",""],["slot","start"],[1,"ion-padding"],[3,"message","type","isVisible"],[3,"formGroup"],["position","floating"],["formControlName","startTime","type","time","placeholder","Ingresa la hora de salida"],["readonly","true",3,"click","value"],[3,"isOpen"],["formControlName","availableSeats","type","number","min","1","placeholder","\xbfCu\xe1ntos asientos tienes libres?"],["formControlName","waypoint","type","text","placeholder","Selecciona un punto"],["expand","full","color","danger",3,"click"],["id","map",2,"height","400px","width","100%"],["expand","full","type","button",3,"click"],["expand","full","color","primary",3,"click"],["displayFormat","DD/MM/YYYY","presentation","date",3,"ionChange","ionCancel","value"]],template:function(i,o){if(1&i){const s=t.RV6();t.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),t.nrm(3,"ion-back-button"),t.k0s(),t.j41(4,"ion-title"),t.EFF(5,"Crear Rutas"),t.k0s()()(),t.j41(6,"ion-content",2),t.nrm(7,"app-notification",3),t.j41(8,"form",4)(9,"ion-item")(10,"ion-label",5),t.EFF(11,"Hora de Salida"),t.k0s(),t.nrm(12,"ion-input",6),t.k0s(),t.j41(13,"ion-item")(14,"ion-label",5),t.EFF(15,"Fecha"),t.k0s(),t.j41(16,"ion-input",7),t.nI1(17,"date"),t.bIt("click",function(){return t.eBV(s),t.Njj(o.openDatePicker())}),t.k0s()(),t.j41(18,"ion-modal",8),t.DNE(19,D,2,1,"ng-template"),t.k0s(),t.j41(20,"ion-item")(21,"ion-label",5),t.EFF(22,"Asientos disponibles"),t.k0s(),t.nrm(23,"ion-input",9),t.k0s(),t.j41(24,"ion-item")(25,"ion-label",5),t.EFF(26,"Agregar Punto de Parada"),t.k0s(),t.nrm(27,"ion-input",10,0),t.k0s(),t.j41(29,"ion-button",11),t.bIt("click",function(){return t.eBV(s),t.Njj(o.clearMap())}),t.EFF(30,"Limpiar Mapa"),t.k0s(),t.nrm(31,"div",12)(32,"br"),t.j41(33,"ion-button",13),t.bIt("click",function(){return t.eBV(s),t.Njj(o.onCreateRoute())}),t.EFF(34,"Crear Ruta"),t.k0s()(),t.j41(35,"ion-button",14),t.bIt("click",function(){return t.eBV(s),t.Njj(o.testNotification())}),t.EFF(36," Probar Notificaci\xf3n "),t.k0s()()}2&i&&(t.R7$(7),t.Y8G("message",o.notificationMessage)("type",o.notificationType)("isVisible",o.isNotificationVisible),t.R7$(),t.Y8G("formGroup",o.routeForm),t.R7$(8),t.Y8G("value",t.i5U(17,6,o.selectedDate,"dd/MM/yyyy")),t.R7$(2),t.Y8G("isOpen",o.isDatePickerOpen))},dependencies:[l.qT,l.BC,l.cb,n.Jm,n.QW,n.W9,n.A9,n.eU,n.$w,n.uz,n.he,n.BC,n.ai,n.Sb,n.su,n.Je,n.Gw,n.el,n.T6,l.j4,l.JD,y.z,d.vh],styles:["ion-item[_ngcontent-%COMP%]{--background: $background-color;--border-radius: $border-radius;margin-bottom:16px}#map[_ngcontent-%COMP%]{height:300px;width:100%;margin-top:20px;border-radius:10px;position:relative;overflow:hidden}ion-button[_ngcontent-%COMP%]{margin-top:10px;--background: #87CEFA !important;--border-radius: 8px}ion-label[_ngcontent-%COMP%]{color:#004cd1}ion-input[_ngcontent-%COMP%], ion-datetime[_ngcontent-%COMP%]{--padding-start: $spacing / 2;font-size:16px}"]})}return r})()}];let b=(()=>{class r{static#t=this.\u0275fac=function(i){return new(i||r)};static#e=this.\u0275mod=t.$C({type:r});static#i=this.\u0275inj=t.G2t({imports:[h.iI.forChild(T),h.iI]})}return r})();var R=u(3887);let P=(()=>{class r{static#t=this.\u0275fac=function(i){return new(i||r)};static#e=this.\u0275mod=t.$C({type:r});static#i=this.\u0275inj=t.G2t({imports:[d.MD,l.YN,n.bv,b,l.YN,l.X1,R.G]})}return r})()}}]);